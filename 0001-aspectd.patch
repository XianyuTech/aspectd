From f51208f9f6f7b13624e71d7c02eacbeb9285db45 Mon Sep 17 00:00:00 2001
From: gentrio <gentriolee@gmail.com>
Date: Fri, 4 Dec 2020 10:23:48 +0800
Subject: [PATCH] aspectd

---
 packages/flutter_tools/lib/src/aspectd.dart   | 221 ++++++++++++++++++
 .../lib/src/build_system/targets/dart.dart    |   9 +
 2 files changed, 230 insertions(+)
 create mode 100644 packages/flutter_tools/lib/src/aspectd.dart

diff --git a/packages/flutter_tools/lib/src/aspectd.dart b/packages/flutter_tools/lib/src/aspectd.dart
new file mode 100644
index 0000000000..13b201c8cc
--- /dev/null
+++ b/packages/flutter_tools/lib/src/aspectd.dart
@@ -0,0 +1,221 @@
+// Copyright 2018 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+import 'dart:io';
+
+import 'artifacts.dart';
+import 'base/common.dart';
+import 'base/file_system.dart';
+import 'build_info.dart';
+import 'build_system/build_system.dart';
+import 'build_system/targets/dart.dart';
+import 'cache.dart';
+import 'compile.dart';
+import 'dart/package_map.dart';
+import 'globals.dart' as globals;
+
+const String aspectdImplPackageRelPath = '..';
+const String aspectdImplPackageName = 'aspectd_impl';
+const String frontendServerDartSnapshot = 'frontend_server.dart.snapshot';
+
+class AspectdHook {
+  static String aspectdTransformerSnapshot;
+
+  static Directory getAspectdImplDirectory(Directory rootProjectDir) {
+    return globals.fs.directory(globals.fs.path.normalize(globals.fs.path.join(
+        rootProjectDir.path,
+        aspectdImplPackageRelPath,
+        aspectdImplPackageName)));
+  }
+
+  static Future<Directory> getPackagePathFromConfig(
+      String packageConfigPath, String packageName) async {
+    final PackageMap packageConfig = PackageMap(globals.fs.path.join(packageConfigPath), fileSystem: globals.fs)..load();
+    for (final String key in packageConfig?.map?.keys?.toList() ?? []) {
+      if (key == packageName) {
+        return globals.fs.directory(globals.fs.path.dirname(packageConfig.map[key].toFilePath()));
+      }
+    }
+    return null;
+  }
+
+  static Future<Directory> getFlutterFrontendServerDirectory(
+      String packagesPath) async {
+    return globals.fs.directory(globals.fs.path.join(
+        (await getPackagePathFromConfig(packagesPath, 'aspectd')).absolute.path,
+        'lib',
+        'src',
+        'flutter_frontend_server'));
+  }
+
+  static Future<bool> isAspectdEnabled() async {
+    final Directory currentDirectory = globals.fs.currentDirectory;
+    final Directory aspectdDirectory =
+        getAspectdImplDirectory(currentDirectory);
+    final String aspectdImplPackagesPath = globals.fs.path
+        .join(aspectdDirectory.absolute.path, kPackagesFileName);
+    final Directory flutterFrontendServerDirectory =
+        await getFlutterFrontendServerDirectory(aspectdImplPackagesPath);
+    if (!(aspectdDirectory.existsSync() &&
+        flutterFrontendServerDirectory.existsSync() &&
+        currentDirectory.absolute.path != aspectdDirectory.absolute.path &&
+        globals.fs
+            .file(globals.fs.path.join(aspectdDirectory.path, 'pubspec.yaml'))
+            .existsSync() &&
+        globals.fs
+            .file(
+                globals.fs.path.join(aspectdDirectory.path, kPackagesFileName))
+            .existsSync() &&
+        globals.fs
+            .file(globals.fs.path.join(
+                aspectdDirectory.path, 'lib', aspectdImplPackageName + '.dart'))
+            .existsSync())) {
+      return false;
+    }
+    return await checkAspectdFlutterFrontendServerSnapshot(
+        aspectdImplPackagesPath);
+  }
+
+  static Future<bool> checkAspectdFlutterFrontendServerSnapshot(
+      String packagesPath) async {
+    final Directory flutterFrontendServerDirectory =
+        await getFlutterFrontendServerDirectory(packagesPath);
+    final String aspectdFlutterFrontendServerSnapshot = globals.fs.path.join(
+        flutterFrontendServerDirectory.absolute.path,
+        frontendServerDartSnapshot);
+    final String defaultFlutterFrontendServerSnapshot = globals.artifacts
+        .getArtifactPath(Artifact.frontendServerSnapshotForEngineDartSdk);
+    if (!globals.fs.file(aspectdFlutterFrontendServerSnapshot).existsSync()) {
+      final String dartSdkDir = await getDartSdkDependency(
+          (await getPackagePathFromConfig(packagesPath, 'aspectd'))
+              .absolute
+              .path);
+
+      final String frontendServerPackageConfigJsonFile =
+          '${flutterFrontendServerDirectory.absolute.path}/package_config';
+      final String rebasedFrontendServerPackageConfigJsonFile =
+          '${flutterFrontendServerDirectory.absolute.path}/rebased_package_config';
+      String frontendServerPackageConfigJson = globals.fs
+          .file(frontendServerPackageConfigJsonFile)
+          .readAsStringSync();
+      frontendServerPackageConfigJson = frontendServerPackageConfigJson
+          .replaceAll('../../../third_party/dart', dartSdkDir);
+      globals.fs
+          .file(rebasedFrontendServerPackageConfigJsonFile)
+          .writeAsStringSync(frontendServerPackageConfigJson);
+
+      final List<String> commands = <String>[
+        globals.artifacts.getArtifactPath(Artifact.engineDartBinary),
+        '--deterministic',
+        '--packages=$rebasedFrontendServerPackageConfigJsonFile',
+        '--snapshot=$aspectdFlutterFrontendServerSnapshot',
+        '--snapshot-kind=kernel',
+        '${flutterFrontendServerDirectory.absolute.path}/starter.dart'
+      ];
+      final ProcessResult processResult =
+          await globals.processManager.run(commands);
+      globals.fs.file(rebasedFrontendServerPackageConfigJsonFile).deleteSync();
+      if (processResult.exitCode != 0 ||
+          globals.fs.file(aspectdFlutterFrontendServerSnapshot).existsSync() ==
+              false) {
+        throwToolExit(
+            'Aspectd unexpected error: ${processResult.stderr.toString()}');
+      }
+    }
+    if (globals.fs.file(defaultFlutterFrontendServerSnapshot).existsSync()) {
+      globals.fs.file(defaultFlutterFrontendServerSnapshot).deleteSync();
+    }
+    globals.fs
+        .file(aspectdFlutterFrontendServerSnapshot)
+        .copySync(defaultFlutterFrontendServerSnapshot);
+    return true;
+  }
+
+  static Future<String> getDartSdkDependency(String aspectdDir) async {
+    final ProcessResult processResult = await globals.processManager.run(
+        <String>[
+          globals.fs.path.join(
+              globals.artifacts.getArtifactPath(Artifact.engineDartSdkPath),
+              'bin',
+              'pub'),
+          'get',
+          '--verbosity=warning'
+        ],
+        workingDirectory: aspectdDir,
+        environment: <String, String>{'FLUTTER_ROOT': Cache.flutterRoot});
+    if (processResult.exitCode != 0) {
+      throwToolExit(
+          'Aspectd unexpected error: ${processResult.stderr.toString()}');
+    }
+    final Directory kernelDir = await getPackagePathFromConfig(
+        globals.fs.path.join(aspectdDir, kPackagesFileName), 'kernel');
+    return kernelDir.parent.parent.path;
+  }
+
+  Future<void> runBuildDillCommand(Environment environment) async {
+    final Directory aspectdDir =
+        getAspectdImplDirectory(globals.fs.currentDirectory);
+    final Directory previousDirectory = globals.fs.currentDirectory;
+    globals.fs.currentDirectory = aspectdDir;
+
+    String relativeDir = environment.outputDir.absolute.path
+        .substring(environment.projectDir.absolute.path.length + 1);
+    final String outputDir = globals.fs.path.join(aspectdDir.path, relativeDir);
+
+    final String buildDir =
+        globals.fs.path.join(aspectdDir.path, '.dart_tool', 'flutter_build');
+
+    final Map<String, String> defines = environment.defines;
+    defines[kTargetFile] = globals.fs.path
+        .join(aspectdDir.path, 'lib', aspectdImplPackageName + '.dart');
+
+    final Environment auxEnvironment = Environment(
+        outputDir: globals.fs.directory(outputDir),
+        buildDir: globals.fs.directory(buildDir),
+        projectDir: aspectdDir,
+        defines: defines,
+        cacheDir: environment.cacheDir,
+        flutterRootDir: environment.flutterRootDir,
+        artifacts: environment.artifacts,
+        fileSystem: environment.fileSystem,
+        logger: environment.logger,
+        processManager: environment.processManager,
+    );
+
+    const KernelSnapshot auxKernelSnapshot = KernelSnapshot();
+    final CompilerOutput compilerOutput =
+        await auxKernelSnapshot.buildImpl(auxEnvironment);
+
+    final String aspectdDill = compilerOutput.outputFilename;
+    final File originalDillFile = globals.fs.file(
+        globals.fs.path.join(environment.buildDir.absolute.path, 'app.dill'));
+    if (originalDillFile.existsSync()) {
+      originalDillFile.renameSync(originalDillFile.absolute.path + '.bak');
+    }
+    globals.fs.file(aspectdDill).copySync(originalDillFile.absolute.path);
+    globals.fs.currentDirectory = previousDirectory;
+  }
+
+  Future<ProcessResult> transformDill(
+      BuildMode buildMode, String inputDill, String outputDill) async {
+    final List<String> command = <String>[
+      globals.artifacts.getArtifactPath(Artifact.engineDartBinary),
+      aspectdTransformerSnapshot,
+      '--input',
+      inputDill,
+      if (buildMode != BuildMode.release) ...<String>[
+        '--sdk-root',
+        globals.fs
+                .file(globals.artifacts
+                    .getArtifactPath(Artifact.platformKernelDill))
+                .parent
+                .path +
+            globals.fs.path.separator
+      ],
+      '--output',
+      outputDill
+    ];
+    return globals.processManager.run(command);
+  }
+}
diff --git a/packages/flutter_tools/lib/src/build_system/targets/dart.dart b/packages/flutter_tools/lib/src/build_system/targets/dart.dart
index 102f63a871..96b8571665 100644
--- a/packages/flutter_tools/lib/src/build_system/targets/dart.dart
+++ b/packages/flutter_tools/lib/src/build_system/targets/dart.dart
@@ -3,6 +3,7 @@
 // found in the LICENSE file.
 
 import '../../artifacts.dart';
+import '../../aspectd.dart';
 import '../../base/build.dart';
 import '../../base/file_system.dart';
 import '../../build_info.dart';
@@ -185,6 +186,13 @@ class KernelSnapshot extends Target {
 
   @override
   Future<void> build(Environment environment) async {
+    await buildImpl(environment);
+    if (await AspectdHook.isAspectdEnabled()) {
+      await AspectdHook().runBuildDillCommand(environment);
+    }
+  }
+
+  Future<CompilerOutput> buildImpl(Environment environment) async {
     final KernelCompiler compiler = await kernelCompilerFactory.create(
       FlutterProject.fromDirectory(environment.projectDir),
     );
@@ -252,6 +260,7 @@ class KernelSnapshot extends Target {
     if (output == null || output.errorCount != 0) {
       throw Exception('Errors during snapshot creation: $output');
     }
+    return output;
   }
 }
 
-- 
2.23.0

